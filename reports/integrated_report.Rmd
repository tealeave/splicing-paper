---
title: "RNA Splicing Analysis Report"
author: "David Lin"
date: "`r params$date`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: hide
params:
  config: NULL
  date: !r Sys.Date()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Set the working directory to the project root (Good practice for sourcing)
project_dir <- normalizePath("/home/tealeave/projects/splicing/splicing-paper")
# setwd(project_dir) # Optional: setwd can sometimes cause issues in Rmd

# Load required libraries
library(DESeq2)
library(maser)
library(ggplot2)
library(dplyr)
library(tidyr)
library(pheatmap)
library(DT)

# Source utility functions using absolute paths derived from project_dir
# Ensure these functions exist and are compatible
source(file.path(project_dir, "R/deseq2_functions.R"))
source(file.path(project_dir, "R/rmats_functions.R"))

# Get configuration passed as parameter (should have absolute paths)
config <- params$config

# Verify config is not NULL
if (is.null(config)) {
  stop("Configuration object (params$config) is NULL. Ensure it's passed correctly during rendering.")
}

# --- Path Conversion Removed --- 
# The config object passed via params should already have absolute paths
# generated by analysis_config.R

# Optional: Print a few paths to verify they are absolute
message("Using DESeq2 tables directory: ", config$deseq2$tables_dir)
message("Using rMATS figures directory: ", config$rmats$figures_dir)

```

# Introduction

This report presents the results of RNA splicing analysis, including differential gene expression analysis using DESeq2 and alternative splicing analysis using rMATS/MASER.

## Analysis Overview

The analysis pipeline consists of the following steps:

1. Differential gene expression analysis using DESeq2
2. Alternative splicing analysis using rMATS/MASER
3. Integration of results to identify genes affected by both differential expression and alternative splicing

## Sample Information

```{r sample-info}
# Get the count file path from the config
count_file_rel <- config$deseq2$counts_file 

# Check if the path from config is valid
if (is.null(count_file_rel) || !is.character(count_file_rel) || nchar(count_file_rel) == 0) {
  stop("Invalid count file path retrieved from configuration (config$deseq2$counts_file).")
}

# Ensure the path is absolute (it should be already from analysis_config.R, but double-check)
# Assuming analysis_config.R correctly set the absolute path
count_file_abs <- count_file_rel 
# If it wasn't absolute, you might need:
# count_file_abs <- normalizePath(file.path(project_dir, count_file_rel), mustWork = FALSE)

message("Attempting to load count data from: ", count_file_abs)

# Check if the file exists before trying to load
if (!file.exists(count_file_abs)) {
  stop(paste("Count file specified in config does not exist at the expected absolute path:", count_file_abs))
}

# Load count data using the validated absolute path
counts <- tryCatch({
    load_count_data(count_file_abs)
}, error = function(e) {
    stop(paste("Error loading count data from file:", count_file_abs, "- Error:", e$message))
})

# Check if counts were loaded successfully
if (is.null(counts) || !is.data.frame(counts) || nrow(counts) == 0) {
    stop("Failed to load count data or the loaded data is empty.")
}

# Create sample information table
# Ensure config$deseq2$conditions and config$deseq2$design exist and are valid
if (is.null(config$deseq2$conditions) || is.null(config$deseq2$design) || length(config$deseq2$conditions) != length(config$deseq2$design)) {
    stop("Invalid DESeq2 conditions or design in config.")
}
sample_info <- data.frame(
  Sample = colnames(counts),
  Condition = unlist(
    mapply(
      function(cond, rep_count) rep(cond, rep_count),
      config$deseq2$conditions,
      as.integer(config$deseq2$design),
      SIMPLIFY = FALSE
    )
  )
)

# Display sample information
DT::datatable(sample_info, options = list(pageLength = 10))
```

# Differential Gene Expression Analysis

## PCA Analysis

```{r pca-plot}
# Get the count file path from the config
count_file_rel <- config$deseq2$counts_file

# Check if the path from config is valid
if (is.null(count_file_rel) || !is.character(count_file_rel) || nchar(count_file_rel) == 0) {
  stop("Invalid count file path retrieved from configuration (config$deseq2$counts_file) for PCA plot.")
}

# Ensure the path is absolute
count_file_abs <- count_file_rel
message("PCA Plot: Using count data from: ", count_file_abs)

# Check if the file exists
if (!file.exists(count_file_abs)) {
  stop(paste("PCA Plot: Count file specified in config does not exist:", count_file_abs))
}

# Load count data
counts <- tryCatch({
    load_count_data(count_file_abs)
}, error = function(e) {
    stop(paste("PCA Plot: Error loading count data from file:", count_file_abs, "- Error:", e$message))
})

if (is.null(counts) || !is.data.frame(counts) || nrow(counts) == 0) {
    stop("PCA Plot: Failed to load count data or the loaded data is empty.")
}

# Prepare inputs for DESeqDataSet
reps <- tryCatch(as.integer(config$deseq2$design), warning = function(w) { stop("Invalid config$deseq2$design: Could not convert to integer.") })
condition_groups <- config$deseq2$conditions

# Validate inputs
if (is.null(condition_groups) || length(condition_groups) != length(reps)) {
    stop("PCA Plot: Mismatch between number of conditions and design elements in config.")
}
if (sum(reps) != ncol(counts)) {
    stop(paste("PCA Plot: Sum of design elements (", sum(reps), ") does not match number of columns in count data (", ncol(counts), ")."))
}

# Create DESeq2 dataset
dds <- tryCatch({
    create_deseq_dataset(counts, condition_groups, reps)
}, error = function(e) {
    stop(paste("PCA Plot: Error creating DESeqDataSet object:", e$message))
})

dds <- tryCatch({
    DESeq(dds)
}, error = function(e) {
    stop(paste("PCA Plot: Error running DESeq():", e$message))
})

# Create PCA plot
vsd <- tryCatch({
    vst(dds, blind = FALSE)
}, error = function(e) {
    stop(paste("PCA Plot: Error running vst():", e$message))
})

pca_data <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
pca_plot <- ggplot(pca_data, aes(PC1, PC2, color = condition)) +
  geom_point(size = 3) +
  theme_minimal() +
  ggtitle("PCA of RNA-seq Samples")

# Display PCA plot
print(pca_plot)
```

## Sample Distance Heatmap

```{r sample-distance}
# Create heatmap of sample distances
sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- colnames(vsd)
colnames(sampleDistMatrix) <- colnames(vsd)

# Display heatmap
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         main = "Sample Distance Heatmap")
```

## Differential Expression Results

```{r deseq2-results}
# Construct absolute paths to DESeq2 result files
result_files <- lapply(config$deseq2$output_files, function(file) {
  # Use the specific tables directory from config
  file.path(config$deseq2$tables_dir, file) 
})

# Create list to store results
deseq2_results <- list()

# Load results for each comparison
for (i in seq_along(result_files)) {
  if (file.exists(result_files[[i]])) {
    deseq2_results[[config$deseq2$output_files[i]]] <- read.csv(result_files[[i]], row.names = 1) # Use filename as key
  } else {
    warning(paste("DESeq2 result file not found:", result_files[[i]]))
  }
}

# Check if any results were loaded
if (length(deseq2_results) == 0) {
    stop("No DESeq2 result files were found or loaded. Check paths and previous steps.")
}

# Display summary of differential expression results
summary_table <- data.frame(
  Comparison = sapply(seq_along(config$deseq2$comparisons), function(i) {
    paste(config$deseq2$comparisons[[i]][1], "vs", config$deseq2$comparisons[[i]][2])
  }),
  # Match results based on comparison names derived from output_files if needed
  # This assumes order matches, which might be fragile. A named list is better.
  TotalGenes = sapply(deseq2_results, nrow),
  SignificantGenes = sapply(deseq2_results, function(df) sum(df$FDR < config$deseq2$fdr_cutoff, na.rm = TRUE)),
  UpregulatedGenes = sapply(deseq2_results, function(df) sum(df$FDR < config$deseq2$fdr_cutoff & df$log2FoldChange > 0, na.rm = TRUE)),
  DownregulatedGenes = sapply(deseq2_results, function(df) sum(df$FDR < config$deseq2$fdr_cutoff & df$log2FoldChange < 0, na.rm = TRUE))
)

# Display summary table
DT::datatable(summary_table, options = list(pageLength = 10))
```

## MA Plots

```{r ma-plots, fig.height=8, fig.width=10}
# Create MA plots for each comparison
# Ensure the number of plots fits the layout (e.g., 2x2)
num_comparisons <- length(deseq2_results)
if (num_comparisons > 0) {
    plot_rows <- ceiling(sqrt(num_comparisons))
    plot_cols <- ceiling(num_comparisons / plot_rows)
    par(mfrow = c(plot_rows, plot_cols))
    
    for (i in seq_along(deseq2_results)) {
      # Create DESeq2 results object from the loaded data frame
      # Ensure column names match exactly (e.g., PValue vs pvalue, FDR vs padj)
      current_res_df <- deseq2_results[[i]]
      res <- DESeqResults(
        DataFrame(
          baseMean = current_res_df$baseMean,
          log2FoldChange = current_res_df$log2FoldChange,
          pvalue = current_res_df$PValue, # Adjust if column name is different
          padj = current_res_df$FDR      # Adjust if column name is different
        )
      )
      
      # Get comparison name for title (assuming order matches config$deseq2$comparisons)
      comp_name <- paste(config$deseq2$comparisons[[i]][1], "vs", config$deseq2$comparisons[[i]][2])
      
      # Plot MA plot
      plotMA(res, main = paste("MA Plot:", comp_name), ylim=c(-5,5)) # Added ylim for consistency
    }
} else {
    cat("No DESeq2 results available to generate MA plots.")
}
```

# Alternative Splicing Analysis

## Summary of Alternative Splicing Events

```{r splicing-summary}
# Use the specific summary tables directory from config
splicing_dir <- config$rmats$summary_tables_dir 
summary_files <- list.files(splicing_dir, pattern = "_summary.csv", full.names = TRUE)

# Create list to store results
splicing_summaries <- list()

# Load summary for each comparison
for (file in summary_files) {
  comparison <- gsub("_summary.csv", "", basename(file))
  # Check if file exists and is not empty
  if (file.exists(file) && file.info(file)$size > 0) {
    df <- tryCatch({
      read.csv(file)
    }, error = function(e) {
      warning(paste("Error reading file:", file, "-", e$message))
      return(NULL)
    })
    
    if (!is.null(df) && nrow(df) > 0) {
      splicing_summaries[[comparison]] <- df
    }
  }
}

# Check if we have any valid summaries
if (length(splicing_summaries) > 0) {
  # Safely combine all summaries
  all_summaries <- tryCatch({
    # Use bind_rows which is safer than cbind for combining data frames
    bind_rows(lapply(names(splicing_summaries), function(comp) {
      # Add the comparison column to each data frame
      df <- splicing_summaries[[comp]]
      df$Comparison <- comp
      return(df)
    }))
  }, error = function(e) {
    warning(paste("Error combining summaries:", e$message))
    return(NULL)
  })
  
  # Display summary table if we have data
  if (!is.null(all_summaries) && nrow(all_summaries) > 0) {
    DT::datatable(all_summaries, options = list(pageLength = 10))
  } else {
    cat("No valid splicing summary data available.")
  }
} else {
  cat("No splicing summary files found or all files were empty.")
}
```

## Volcano Plots

```{r volcano-plots, fig.height=10, fig.width=12}
# Use the specific figures directory from config
volcano_dir <- config$rmats$figures_dir 
volcano_files <- list.files(volcano_dir, pattern = "_volcano.pdf", full.names = TRUE)

# Display message if no volcano plots are found
if (length(volcano_files) == 0) {
  cat("No volcano plot images found in", volcano_dir)
} else {
  # Display a message about where to find the volcano plots
  cat("Volcano plots for alternative splicing events are available in the following directory:", volcano_dir)
}
```

# Integration of Results

## Genes Affected by Both Differential Expression and Alternative Splicing

```{r integrated-analysis}
# Use the specific event tables directory from config
# Decide whether to use RDS or CSV files based on pipeline output
event_tables_dir <- config$rmats_maser_event_tables_dir

message("**DEBUG** event_tables_dir: ", event_tables_dir)
message("**DEBUG** dir.exists: ", dir.exists(event_tables_dir))

message("Config fields: ", paste(names(config), collapse = ", "))

# Option 1: Load from RDS files (saved by updated rmats_functions.R)
rds_files <- list.files(event_tables_dir, pattern = "_top_events.rds", full.names = TRUE)
splicing_events_list <- list()
for (file in rds_files) {
    comparison_name <- gsub("_top_events.rds", "", basename(file))
    maser_obj <- tryCatch(readRDS(file), error = function(e) { 
        warning(paste("Error reading RDS file:", file, "-", e$message)); NULL 
    })
    if (!is.null(maser_obj)) {
        # Extract significant events summary data frame
        summary_df_list <- tryCatch(summary(maser_obj), error = function(e) { 
             warning(paste("Error getting summary from Maser object:", file, "-", e$message)); NULL 
        })
        if (!is.null(summary_df_list)) {
             # Combine all event types for this comparison into one data frame
             combined_df <- bind_rows(summary_df_list, .id = "EventType")
             splicing_events_list[[comparison_name]] <- combined_df
        } else {
             splicing_events_list[[comparison_name]] <- NULL # Indicate failure
        }
    } else {
        splicing_events_list[[comparison_name]] <- NULL # Indicate failure
    }
}

# Option 2: Load from CSV files (if they were generated)
# event_files <- list.files(event_tables_dir, pattern = "_significant_events.csv", full.names = TRUE)
# splicing_events_list <- list()
# for (file in event_files) {
#   key <- gsub("_significant_events.csv", "", basename(file))
#   splicing_events_list[[key]] <- read.csv(file)
# }

# Check if any splicing events were loaded
if (length(splicing_events_list) == 0 || all(sapply(splicing_events_list, is.null))) {
    stop("No significant splicing event data found or loaded. Check paths and previous rMATS steps.")
}

# Extract gene IDs from splicing events (handle potential missing columns)
splicing_genes_by_comparison <- lapply(splicing_events_list, function(df) {
  if (is.null(df) || nrow(df) == 0) return(character(0))
  
  gene_col <- NULL
  if ("geneSymbol" %in% colnames(df)) {
    gene_col <- "geneSymbol"
  } else if ("GeneID" %in% colnames(df)) {
    gene_col <- "GeneID"
  }
  
  if (!is.null(gene_col)) {
    # Group by event type within the comparison
    split(df[[gene_col]], df$EventType)
  } else {
    warning("Could not find 'geneSymbol' or 'GeneID' column in splicing events data frame.")
    list() # Return an empty list if no gene column found
  }
})

# Extract differentially expressed genes (using named list is better)
de_genes_by_comparison <- lapply(names(deseq2_results), function(res_key) {
    df <- deseq2_results[[res_key]]
    # Extract comparison name from the key (e.g., filename)
    # This assumes a consistent naming convention
    comp_name <- gsub("_deseq2_results.csv", "", res_key)
    comp_name <- gsub("_", " ", comp_name) # Replace underscores if needed for matching
    
    list(name = comp_name, genes = rownames(df)[df$FDR < config$deseq2$fdr_cutoff & !is.na(df$FDR)])
})
names(de_genes_by_comparison) <- sapply(de_genes_by_comparison, `[[`, "name")

# Find overlap between DE and AS genes
overlap_results <- data.frame(
  Comparison = character(),
  EventType = character(),
  DEGenes = integer(),
  ASGenes = integer(),
  OverlapGenes = integer(),
  stringsAsFactors = FALSE
)

# Iterate through rMATS comparisons
for (as_comp_name in names(splicing_genes_by_comparison)) {
    # Find matching DESeq2 comparison (requires careful name matching)
    # Example: Match "468_0_v_468_12" (rMATS) with "MB468_720mins vs MB468_0mins" (DESeq2)
    # This matching logic needs to be robust based on actual comparison names
    # For now, let's assume a direct match or implement specific logic if needed
    matched_de_comp <- NULL
    # Simple example match (adjust as needed):
    if (as_comp_name == "468_0_v_468_12") { # Match rMATS comparison name
        # Find the corresponding DESeq2 comparison name
        # This depends on how config$deseq2$comparisons maps to rMATS comparisons
        # Assuming it corresponds to the 3rd DESeq2 comparison: "MB468_720mins vs MB468_0mins"
        target_de_name <- paste(config$deseq2$comparisons[[3]][1], "vs", config$deseq2$comparisons[[3]][2])
        if (target_de_name %in% names(de_genes_by_comparison)) {
             matched_de_comp <- de_genes_by_comparison[[target_de_name]]
        }
    }
    # Add more matching logic here if needed for other comparisons

    if (is.null(matched_de_comp)) {
        warning(paste("Could not find matching DESeq2 comparison for rMATS comparison:", as_comp_name))
        next
    }
    
    de_set <- matched_de_comp$genes
    as_genes_by_type <- splicing_genes_by_comparison[[as_comp_name]]
    
    # Iterate through event types within the rMATS comparison
    for (event_type in names(as_genes_by_type)) {
        as_set <- unique(as_genes_by_type[[event_type]])
        overlap <- intersect(de_set, as_set)
        
        # Add to results
        overlap_results <- rbind(overlap_results, data.frame(
          Comparison = matched_de_comp$name, # Use the DESeq2 comparison name
          EventType = event_type,
          DEGenes = length(de_set),
          ASGenes = length(as_set),
          OverlapGenes = length(overlap),
          stringsAsFactors = FALSE
        ))
    }
}

# Display overlap results
if (nrow(overlap_results) > 0) {
  DT::datatable(overlap_results, options = list(pageLength = 10))
} else {
  cat("No overlap found between differentially expressed genes and alternatively spliced genes based on current matching logic.")
}
```

# Conclusion

This report presents the results of RNA splicing analysis, including differential gene expression and alternative splicing. The integration of these results provides insights into genes that are affected by both mechanisms, which may play important roles in the biological processes under study.

```{r session-info}
# Display session information
sessionInfo()
```